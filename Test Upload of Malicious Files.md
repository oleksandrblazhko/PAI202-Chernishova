
4.10.9 Тестове завантаження шкідливих файлів (англ. Test Upload of Malicious Files)

<table>
    <thead>
       <tr>
        <th><b>ID</b> </th>
        </tr>
    </thead>
 <tbody>
        <tr>
<td> WSTG-BUSL-09</td>
         </tr> 
    </tbody>
</table>

## Загальні положення

Багато бізнес-процесів програми дозволяють користувачам завантажувати до них якісь дані. Незважаючи на те, що перевірка введення параметрів широко використовуються для текстових полів введення, її складніше реалізувати, коли завантажуються цілі файли. Хоча багато сайтів реалізують прості обмеження на основі списку дозволених (або заблокованих) розширень, цього недостатньо, щоб запобігти зловмисникам завантажувати дозволені типи файлів зі шкідливим вмістом.

Вразливості, пов’язані із завантаженням шкідливих файлів, унікальні тим, що ці «шкідливі» файли можна легко відхилити за допомогою включення бізнес-логіки, яка скануватиме файли під час процесу завантаження та відхилятиме ті, які сприймаються як шкідливі. Крім того, це відрізняється від завантаження неочікуваних файлів тим, що хоч тип файлу може бути дозволеним для прийняття, файл може бути шкідливим для системи.

Нарешті, слово «зловмисний» має різне значення для різних систем, наприклад, шкідливі файли, які можуть використовувати вразливості SQL-сервера, не можуть вважатися «зловмисними» в середовищі, що використовує сховище даних NoSQL.

Програма може дозволяти завантажувати зловмисні файли, які містять експлойти або шелл-код, не перевіряючи їх на зловмисні файли. Шкідливі файли можуть бути виявлені та зупинені в різних точках архітектури програми, наприклад: в IPS/IDS, антивірусном програмном забезпеченні сервера програми або антивірусном скануванні програмою під час завантаження файлів (можливо, розвантажування сканування за допомогою SCAP).

### Приклад 
Типовим прикладом цієї вразливості є такі програми, як блог або форум, які дозволяють користувачам завантажувати зображення та інші мультимедійні файли. Хоча вони вважаються безпечними, зловмисник має можливість завантажити виконуваний код (наприклад, сценарій PHP), що дозволить йому виконувати команди операційної системи, читати та змінювати інформацію у файловій системі, отримати доступ до внутрішньої бази даних і повністю скомпрометувати сервер.

## Цілі тестування
* Визначте функцію завантаження файлів.
* Перегляньте проектну документацію, щоб визначити, які типи файлів вважаються прийнятними, а які небезпечними або шкідливими.
    * Якщо документація недоступна, подумайте про те, що було б доречним, почати з розуміння мети програми.
* Визначте, як обробляються завантажені файли.
* Отримайте або створіть набір шкідливих файлів для тестування.
* Спробуйте завантажити шкідливі файли в програму та визначте, чи вона прийнята та оброблена.

## Методи тестування

### Шкідливі типи файлів

Найпростіша перевірка, яку може виконати програма, полягає в тому, щоб визначити, що можна завантажувати лише надійні типи файлів.

### Веб-оболонки

Якщо сервер налаштовано на виконання коду, тоді можна отримати виконання команд на сервері, завантаживши файл, відомий як веб-оболонка, який дозволяє виконувати довільний код або команди операційної системи. Щоб ця атака була успішною, файл має бути завантажений у веб-корінь, а сервер має бути налаштований для виконання коду.

Завантаження такого типу оболонки на сервер, що виходить в Інтернет, є небезпечним, оскільки це дозволяє кожному, хто знає (або здогадується) про розташування оболонки, виконувати код на сервері. Щоб захистити оболонку від несанкціонованого доступу, можна використати ряд методів, наприклад:

* Завантаження оболонки з випадково згенерованим іменем.
* Пароль, що захищає оболонку.
* Впровадження обмежень на основі IP для оболонки.

## Після закінчення роботи треба видалити веб-оболонку.

У наведеному нижче прикладі показано просту оболонку на основі PHP, яка виконує команди операційної системи, передані їй у параметрі GET, і до якої можна отримати доступ лише з певної IP-адреси:


```php
<?php
    if ($_SERVER['REMOTE_HOST'] === "FIXME") { // Set your IP address here</br>
        if(isset($_REQUEST['cmd'])){
        $cmd = ($_REQUEST['cmd']); 
        echo "<pre>\n"; 
        system($cmd); echo "</pre>";
        }
    }
?>
```

Після завантаження оболонки (з випадковою назвою) Ви можете виконувати команди операційної системи, передаючи їх у параметрі GET за викликом команди cmd:

https://example.org/7sna8uuorvcx3x4fx.php?cmd=cat+/etc/passwd

### Ухилення фільтрації

Перший крок — визначити, що фільтри дозволяють робтти, що блокують, і де вони реалізовані. Якщо обмеження виконуються на стороні клієнта за допомогою JavaScript, їх можна тривіально обійти за допомогою проксі-сервера-перехоплювача.

Якщо фільтрація виконується на стороні сервера, можна спробувати обійти її різними методами, зокрема:

* Змініть значення Content-Type як image/jpeg у запиті HTTP.
* Змініть розширення на менш поширене розширення, наприклад file.php5, file.shtml, file.asa, file.jsp, file.jspx, file.aspx, file.asp, file.phtml, file.cshtml
* Змініть використання великих літер розширення, наприклад file.PhP або file.AspX
* Якщо запит містить кілька імен файлів, змініть їх на різні значення.
* Використання спеціальних кінцевих символів, таких як пробіли, крапки або нульові символи, наприклад file.asp..., file.php;jpg, file.asp%00.jpg, 1.jpg%00.php
У погано налаштованих версіях nginx завантаження файлу у вигляді test.jpg/x.php може дозволити виконати його як x.php.

## Зловмисний вміст файлу
Після перевірки типу файлу важливо переконатися, що вміст файлу безпечний. Це значно важче зробити, оскільки необхідні кроки відрізнятимуться залежно від типів дозволених файлів.

### Шкідливе програмне забезпечення

Програми звичайно повинні сканувати завантажені файли за допомогою антишкідливого програмного забезпечення, щоб переконатися, що вони не містять нічого шкідливого. Найпростіший спосіб перевірити це є підключення тестового файлу EICAR, який є безпечним файлом, але який позначається шкідливим усім програмним забезпеченням для захисту від шкідливих програм.

Залежно від типу програми може знадобитися перевірка на інші небезпечні типи файлів, наприклад документи Office, що містять шкідливі макроси. Такі інструменти, як Metasploit Framework і Social Engineer Toolkit (SET), можна використовувати для створення шкідливих файлів для різних форматів.

Коли цей файл завантажується, він має бути виявлений і «поміщений у карантин» або видалений програмою. Залежно від того, як програма обробляє файл, може бути неочевидно, що з ним скоїлося.

### Обхід каталогу архіву

Якщо програма розпаковує архіви (наприклад, Zip-файли), то є можливим запис у непередбачені місця за допомогою обходу каталогу. Цим можна скористатися, завантаживши шкідливий zip-файл, який містить шляхи, які проходять через файлову систему за допомогою таких послідовностей, як ..\..\..\..\shell.php. Ця техніка обговорюється далі в консультації snyk.

### Zip бомби

Zip-бомба (широко відома як декомпресійна бомба) — це архівний файл, який містить великий обсяг даних. Він має на меті спричинити відмову в обслуговуванні, вичерпавши дисковий простір або пам’ять цільової системи, яка намагається розпакувати архів. Зауважте, що хоч формат Zip є найкращим прикладом цього, інші формати також можуть мати негативний вплив, зокрема gzip (який часто використовується для стиснення даних під час передавання).

На найпростішому рівні Zip-бомбу можна створити, стиснувши великий файл, що складається з одного символу. У наведеному нижче прикладі показано, як створити файл розміром 1 МБ, який буде розпаковано до 1 ГБ:

dd if=/dev/zero bs=1M count=1024 | zip -9 > bomb.zip

Існує ряд методів, які можна використовувати для досягнення значно вищого коефіцієнта стиснення, включаючи кілька рівнів стиснення, зловживання форматом Zip і quines (які є архівами, що містять свою копію, спричиняючи нескінченну рекурсію).

Успішна бомбова атака Zip призведе до відмови в обслуговуванні, а також може призвести до збільшення витрат, якщо використовується хмарна платформа з автоматичним масштабуванням. <b> Не здійснюйте такого роду атаки, якщо Ви не врахували ці ризики та не отримали письмового дозволу на це </b>.

### Файли XML

XML-файли мають низку потенційних вразливостей, таких як XML eXternal Entities (XXE) і атаки на відмову в обслуговуванні, такі як атака «мільярд сміється» (англ. billion laughs attack).

Ці атаки аналізуються далі в посібнику Тестування для впровадження XML.

### Інші формати файлів

Багато інших форматів файлів також мають певні проблеми безпеки, які потрібно враховувати, наприклад:

* Файли CSV можуть допускати атаки ін’єкції CSV.
* Файли Office можуть містити шкідливі макроси або код PowerShell.
* PDF-файли можуть містити шкідливий JavaScript.

Дозволені формати файлів слід ретельно перевіряти на наявність потенційно небезпечних функціональних можливостей і, де це можливо, слід спробувати використати це під час тестування.

### Огляд вихідного коду

Якщо підтримується функція завантаження файлів, у вихідному коді зазвичай можна знайти такі API/методи.

* Java: новий файл, import, upload, getFileName, Download, getOutputString
* C/C++: open, fopen
* PHP: move_uploaded_file(), Readfile, file_put_contents(), file(), parse_ini_file(), copy(), fopen(), include(), require()

## Приклади тестування

* Тестування розширень файлів для конфіденційної інформації
* Тестування XML ін’єкцій
* Тестування завантаження несподіваних файлів


## Санація

Повний захист від завантаження зловмисних файлів може бути складним, і точні кроки, необхідні, залежатимуть від типів файлів, які завантажуються, і того, як файли обробляються чи аналізуються на сервері. Більш детально це обговорюється в шпаргалці для завантаження файлів.

## Інструменти

* Функція генерації корисного навантаження Metasploit
* Перехоплення проксі

## Посилання

* OWASP - File Upload Cheat Sheet
* OWASP - Unrestricted File Upload
* Why File Upload Forms are a Major Security Threat
* 8 Basic Rules to Implement Secure File Uploads
* Stop people uploading malicious PHP files via forms
* How to Tell if a File is Malicious
* CWE-434: Unrestricted Upload of File with Dangerous Type
* Implementing Secure File Upload
* Metasploit Generating Payloads


