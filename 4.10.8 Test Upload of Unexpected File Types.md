# 4.10.8 Тестове завантаження файлів неочікуваних типів (англ. Test Upload of Unexpected File Types) 
<table>
    <thead>
       <tr>
        <th><b> ID </b> </th>
        </tr>
    </thead>
 <tbody>
        <tr>
<td> WSTG-BUSL-08</td>
         </tr> 
    </tbody>
</table>

## Загальні положення

Багато бізнес-процесів додатків дозволяють завантажувати та маніпулювати даними, які надсилаються через файли. Але бізнес-процеси перевіряють файли та дозволяють лише певні «узгоджені» типи файлів. Рішення про те, які файли є «узгодженими», визначається бізнес-логікою та залежить від програми/системи. Ризик полягає в тому, що, дозволяючи користувачам завантажувати файли, зловмисники можуть надіслати файл неочікуваного типу, який може бути опрацьованим та негативно вплинути на програму або систему за допомогою атак, які, наприклад, можуть зіпсувати веб-сайт, виконувати віддалені команди, переглядати системні файли та локальні ресурси, атакувати інші сервери або використовувати локальні вразливості.

Вразливості, пов’язані із завантаженням файлів неочікуваних типів, унікальні тим, що функція завантаження має швидко відхиляти файл, якщо він не має певного розширення. Крім того, це відрізняється від завантаження шкідливих файлів тим, що в більшості випадків неправильний формат файлу сам по собі не може бути «зловмисним», але може завдати шкоди збереженим даним. Наприклад, якщо програма дозволяє приймати файли Windows Excel, у випадку, коли з’явиться подібний файл бази даних, вона його теж прочитає, але витягнуті з нього дані можуть потрапити до неправильних місць.

Програма може очікувати лише певних типів файлів, які мають бути завантажені для обробки, як-от файли .csv або .txt. Програма може не перевірити завантажений файл за розширенням (якщо перевірка файлу має низький рівень надійності) або вмістом (перевірка файлу з високим рівнем надійності). Це може призвести до неочікуваних результатів у системі або у бази даних у програмі/системі або дати зловмисникам додаткові методи використання програми/системи.

### Приклад 
Припустимо, програма обміну зображеннями дозволяє користувачам завантажувати графічний файл з розширенням .gif або .jpg на веб-сайт. Що робити, якщо зловмисник може завантажити файл HTML із тегом <script> у ньому або файл PHP? Система може перемістити файл із тимчасового розташування в остаточне розташування, де PHP-код тепер можна буде виконати для програми чи системи.

## Цілі тестування
* Перегляньте проектну документацію щодо типів файлів, які система відхиляє.
* Переконайтеся, що небажані типи файлів відхиляються та обробляються безпечно.
* Переконайтеся, що пакетне завантаження файлів є безпечним і не допускає жодного обходу встановлених заходів безпеки.

## Методи тестування
### Спеціальний метод тестування
* Вивчіть логічні вимоги програми.
* Підготуйте бібліотеку файлів, які «не схвалені» для завантаження, яка може містити такі файли, як: jsp, exe або файли HTML, що містять різні сценарії.
* У програмі перейдіть до механізму надсилання або завантаження файлів.
* Надішліть файл, який не «не було схвалено» для завантаження та переконайтеся, що його завантаження належним чином заборонено.
* Перевірте, чи перевіряє веб-сайт лише тип файлу в JavaScript на стороні клієнта
* Перевірте, чи веб-сайт перевіряє лише тип файлу аналізуючи «Content-Type» у запиті HTTP.
* Перевірте, чи веб-сайт перевіряє лише розширення файлу.
* Перевірте, чи можна отримати прямий доступ до інших завантажених файлів за вказаною URL-адресою.
* Перевірте, чи може завантажений файл містити код або ін’єкцію сценарію.
* Перевірте, чи існує аналіз шляху до завантажених файлів. Зокрема, хакери можуть стискати файли з указаним шляхом у ZIP, щоб розархівовані файли можна було завантажити за призначеним шляхом після завантаження та розпакування
## Приклади тестування
* Тестування розширень файлів для конфіденційної інформації
* Тестування завантаження шкідливих файлів
## Санація
Програми слід розробляти за механізмами, щоб приймати та маніпулювати лише «прийняті» файли, які решта функціональних можливостей програми можуть опрацювати, чекаючи на них. Деякі конкретні приклади включають: заборона списків або дозвіл списків розширень файлів, використання «Content-Type» із заголовка або використання розпізнавача типів файлів, щоб дозволити лише певні типи файлів у системі.

## References
* OWASP - Unrestricted File Upload
* File upload security best practices: Block a malicious file upload
* Stop people uploading malicious PHP files via forms
* CWE-434: Unrestricted Upload of File with Dangerous Type
